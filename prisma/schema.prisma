// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}


// Experimenter profile data
model Experimenters {
  id          Int          @id @default(autoincrement())
  name        String
  email       String       @unique
  password    String
  created_at  DateTime     @default(now())
  experiments Experiment[]

  @@map("experimenters")
}

// Main experiment container
model Experiment {
  id             Int           @id @default(autoincrement())
  name           String
  description    String 
  isActive       Boolean       @default(false)

  experimenter   Experimenters @relation(fields: [experimenterId], references: [id], onDelete: Cascade)
  experimenterId Int

  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt

  conditions     Condition[]   // One experiment can have multiple conditions
  sessions       PlayerSession[]
  sessionOrders  SessionExperimentOrder[]

  @@map("experiments")
}

// NEW: Condition model - represents different experimental conditions
model Condition {
  id             Int           @id @default(autoincrement())
  name           String        // e.g., "Control", "With Advice", "No Timer", etc.
  description    String?       // Optional description of this condition
  
  // Condition-specific settings (can override experiment defaults)
  adviceformat   String?       // Override experiment's advice format
  timerEnabled   Boolean?      // Override timer setting
  timeLimit      Int?          // Override time limit
  
  experiment     Experiment    @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  experimentId   Int
  
  order          Int           // Order of conditions within experiment
  
  created_at     DateTime      @default(now())
  
  puzzles        Puzzle[]      // Each condition has its own puzzles
  
  @@unique([experimentId, order])
  @@unique([experimentId, name])  // Unique condition names within experiment
  @@map("conditions")
}

// Randomized Level Order 
model SessionExperimentOrder {
  id           Int        @id @default(autoincrement())
  player_Name  String
  experiment   Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  experimentId Int
  conditionId  Int        // MAKE SURE THIS IS NOT NULL
  order        Int        // Level number (1–5)

  created_at   DateTime   @default(now())

  
  @@unique([player_Name, experimentId, order])  
  @@map("session_experiment_orders")
}

// Puzzles now belong to conditions instead of directly to experiments
model Puzzle {
  id           Int       @id @default(autoincrement())
  fen          String    // Chess board state
  correct_move String    // Correct solution
  order        Int       // Order within this condition

  condition    Condition @relation(fields: [conditionId], references: [id], onDelete: Cascade)
  conditionId  Int

  advice       Advice?
  responses    PlayerResponse[]

  @@unique([conditionId, order])  // Unique order within each condition
  @@map("puzzles")
}

// Advice linked to a puzzle (unchanged)
model Advice {
  id           Int     @id @default(autoincrement())
  puzzle       Puzzle  @relation(fields: [puzzleId], references: [id], onDelete: Cascade)
  puzzleId     Int     @unique

  text         String
  confidence   Float?     // Optional confidence %
  explanation  String?    // Optional explanation
  reliability  String     // "Poor", "Moderate", "High"

  @@map("advice")
}

// Player session (minimal changes)
model PlayerSession {
  id             Int       @id @default(autoincrement())
  player_name    String
  experiment     Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  experimentId   Int
  conditionId    Int?      // Track which condition this player is in

  display_level  Int       // Level number (1–5)
  started_at     DateTime  @default(now())
  completed_at   DateTime?

  responses      PlayerResponse[]

  @@unique([player_name, experimentId])
  @@map("player_sessions")
}

// Player's responses to puzzles during a session (unchanged)
model PlayerResponse {
  id                   Int            @id @default(autoincrement())

  session              PlayerSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId            Int
  puzzle               Puzzle         @relation(fields: [puzzleId], references: [id], onDelete: Cascade)
  puzzleId             Int

  move_before_advice   String?        // Optional
  time_before_advice   Int?           // In seconds
  move_after_advice    String?         // Final move submitted
  time_after_advice    Int?           // In seconds

  advice_shown         Boolean        @default(false)
  advice_requested     Boolean        @default(false)
  move_matches_advice  Boolean        @default(false)

  undo_used            Boolean        @default(false)
  time_exceeded        Boolean        @default(false)
  skipped              Boolean        @default(false)

  completed_at         DateTime       @default(now())

  moves                MoveRecord[]   // Full move history

  @@unique([sessionId, puzzleId])
  @@map("player_responses")
}

// Move record (unchanged)
model MoveRecord {
  id             Int            @id @default(autoincrement())
  response       PlayerResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
  responseId     Int

  move           String         // Algebraic move e.g., e2e4
  move_number    Int            // Order in sequence: 1, 2, 3...
  time_taken     Int?           // Time in seconds
  was_undone     Boolean        // True if undone later

  created_at     DateTime       @default(now())
}